name: A.A.I.T.I Production Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: aaiti_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Setup test environment
      run: |
        cd backend
        cp .env.example .env.test
        echo "NODE_ENV=test" >> .env.test
        echo "DATABASE_URL=postgresql://testuser:testpassword@localhost:5432/aaiti_test" >> .env.test
        echo "JWT_SECRET=test_jwt_secret_key_for_github_actions" >> .env.test

    - name: Run database migrations
      run: |
        cd backend
        NODE_ENV=test npm run migrate

    - name: Run backend unit tests
      run: |
        cd backend
        NODE_ENV=test npm test

    - name: Run ML integration tests
      run: |
        cd backend
        NODE_ENV=test npx mocha ../tests/mlIntegrationTests.js --timeout 30000

    - name: Run production trading integration tests
      run: |
        cd backend
        NODE_ENV=test npx mocha ../tests/productionTradingIntegration.test.js --timeout 30000

    - name: Run API integration tests
      run: |
        cd backend
        NODE_ENV=test npx mocha tests/apiTestSuite.js --timeout 20000

    - name: Run security tests
      run: |
        cd backend
        NODE_ENV=test npx mocha tests/security.test.js --timeout 15000

    - name: Generate test coverage
      run: |
        cd backend
        NODE_ENV=test npm run coverage

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage/lcov.info
        flags: backend
        name: backend-coverage

  frontend-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run frontend tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Upload frontend coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  integration-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: aaiti_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: Setup test environment
      run: |
        cd backend
        cp .env.example .env.test
        echo "NODE_ENV=test" >> .env.test
        echo "DATABASE_URL=postgresql://testuser:testpassword@localhost:5432/aaiti_test" >> .env.test
        echo "JWT_SECRET=test_jwt_secret_key_for_github_actions" >> .env.test

    - name: Run database migrations
      run: |
        cd backend
        NODE_ENV=test npm run migrate

    - name: Start backend server in background
      run: |
        cd backend
        NODE_ENV=test npm start &
        sleep 10

    - name: Run end-to-end tests
      run: |
        NODE_ENV=test npx mocha tests/nextGenAI.test.js --timeout 30000
        NODE_ENV=test npx mocha tests/test_advanced_features.js --timeout 20000
        NODE_ENV=test npx mocha tests/test_system_enhancements.js --timeout 20000

    - name: Run system validation
      run: |
        NODE_ENV=test node validate-production-trading.js

  docker-build-test:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t aaiti:test .

    - name: Test Docker container
      run: |
        docker run --name aaiti-test -d -p 5000:5000 aaiti:test
        sleep 30
        curl -f http://localhost:5000/api/health || exit 1
        docker stop aaiti-test
        docker rm aaiti-test

  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security audit
      run: |
        cd backend
        npm audit --audit-level moderate
        cd ../frontend
        npm audit --audit-level moderate

    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium

  performance-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests]

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: aaiti_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: |
        cd backend
        npm ci

    - name: Setup test environment
      run: |
        cd backend
        cp .env.example .env.test
        echo "NODE_ENV=test" >> .env.test
        echo "DATABASE_URL=postgresql://testuser:testpassword@localhost:5432/aaiti_test" >> .env.test

    - name: Run database migrations
      run: |
        cd backend
        NODE_ENV=test npm run migrate

    - name: Start backend server
      run: |
        cd backend
        NODE_ENV=test npm start &
        sleep 10

    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Run performance tests
      run: |
        k6 run --duration=60s --vus=10 backend/tests/performance.js

  deployment-test:
    runs-on: ubuntu-latest
    needs: [integration-tests, docker-build-test, security-scan]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test deployment readiness
      run: |
        echo "âœ… All tests passed"
        echo "âœ… Security scan completed"
        echo "âœ… Docker build successful"
        echo "âœ… Integration tests passed"
        echo "ğŸš€ Ready for deployment"

    - name: Create deployment artifact
      run: |
        mkdir -p deployment
        echo "DEPLOYMENT_TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)" >> deployment/metadata.txt
        echo "GIT_COMMIT=${GITHUB_SHA}" >> deployment/metadata.txt
        echo "GIT_BRANCH=${GITHUB_REF_NAME}" >> deployment/metadata.txt
        echo "TESTS_PASSED=true" >> deployment/metadata.txt

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v3
      with:
        name: deployment-metadata
        path: deployment/

  notify-success:
    runs-on: ubuntu-latest
    needs: [deployment-test]
    if: success()

    steps:
    - name: Notify success
      run: |
        echo "ğŸ‰ All A.A.I.T.I tests passed successfully!"
        echo "âœ… Backend tests: PASSED"
        echo "âœ… Frontend tests: PASSED"
        echo "âœ… Integration tests: PASSED"
        echo "âœ… Security scan: PASSED"
        echo "âœ… Performance tests: PASSED"
        echo "âœ… Docker build: PASSED"
        echo "ğŸš€ Ready for production deployment"

  notify-failure:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests, docker-build-test, security-scan, performance-tests]
    if: failure()

    steps:
    - name: Notify failure
      run: |
        echo "âŒ A.A.I.T.I tests failed!"
        echo "Please check the logs and fix the issues before merging."
        exit 1