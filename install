#!/bin/bash

# A.A.I.T.I Interactive Docker Installer
# One program for everything - Docker-based installation only

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Configuration
PROJECT_NAME="A.A.I.T.I"
VERSION="2.1.0"

# Print header
echo -e "${BLUE}"
cat << EOF
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    üöÄ ${PROJECT_NAME} v${VERSION} - Interactive Installer                     ‚ïë
‚ïë                      Auto AI Trading Interface - Docker Edition                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# Print functions
print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_step() {
    echo -e "${PURPLE}üîß $1${NC}"
}

# ----------------------------------------------------------------------------
# Interactive configuration & admin setup (must be defined before use)
# ----------------------------------------------------------------------------
# ----------------------------------------------------------------------------
# Simplified setup - no configuration prompts
# ----------------------------------------------------------------------------
setup_configuration() {
    return 0
}

# Check if Node.js and npm are installed
check_nodejs() {
    print_step "Checking Node.js installation..."
    
    if ! command -v node &> /dev/null; then
        print_warning "Node.js is not installed. Installing Node.js..."
        
        # Install Node.js based on platform
        if command -v apt &> /dev/null; then
            # Ubuntu/Debian
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
        elif command -v yum &> /dev/null; then
            # RHEL/CentOS
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs npm
        elif command -v brew &> /dev/null; then
            # macOS with Homebrew
            brew install node
        else
            print_error "Cannot automatically install Node.js. Please install manually:"
            echo "Visit: https://nodejs.org/"
            return 1
        fi
    fi
    
    # Check Node.js version
    NODE_VERSION=$(node --version 2>/dev/null | sed 's/v//')
    if [[ $(echo "$NODE_VERSION 18.0.0" | tr " " "\n" | sort -V | head -n1) == "18.0.0" ]]; then
        print_success "Node.js $NODE_VERSION is installed"
    else
        print_warning "Node.js version $NODE_VERSION detected. Version 18+ recommended."
    fi
    
    # Check npm
    if ! command -v npm &> /dev/null; then
        print_error "npm is not installed"
        return 1
    fi
    
    NPM_VERSION=$(npm --version 2>/dev/null)
    print_success "npm $NPM_VERSION is available"
    return 0
}

# Install npm dependencies for all components
install_npm_dependencies() {
    print_step "Installing npm dependencies..."
    
    # Root dependencies
    if [ -f "package.json" ]; then
        print_info "üì¶ Installing root dependencies..."
        if ! npm install --production; then
            print_error "Failed to install root dependencies"
            return 1
        fi
        print_success "Root dependencies installed"
    fi
    
    # Frontend dependencies
    if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
        print_info "üì¶ Installing frontend dependencies..."
        cd frontend
        if ! npm install; then
            print_error "Failed to install frontend dependencies"
            cd ..
            return 1
        fi
        cd ..
        print_success "Frontend dependencies installed"
    fi
    
    # Backend dependencies
    if [ -d "backend" ] && [ -f "backend/package.json" ]; then
        print_info "üì¶ Installing backend dependencies..."
        cd backend
        if ! npm install --production; then
            print_error "Failed to install backend dependencies"
            cd ..
            return 1
        fi
        cd ..
        print_success "Backend dependencies installed"
    fi
    
    # Microservices dependencies
    if [ -d "microservices" ]; then
        # API Gateway
        if [ -f "microservices/api-gateway/package.json" ]; then
            print_info "üì¶ Installing API Gateway dependencies..."
            cd microservices/api-gateway
            if ! npm install --production; then
                print_error "Failed to install API Gateway dependencies"
                cd ../..
                return 1
            fi
            cd ../..
            print_success "API Gateway dependencies installed"
        fi
        
        # Auth Service
        if [ -f "microservices/auth-service/package.json" ]; then
            print_info "üì¶ Installing Auth Service dependencies..."
            cd microservices/auth-service
            if ! npm install --production; then
                print_error "Failed to install Auth Service dependencies"
                cd ../..
                return 1
            fi
            cd ../..
            print_success "Auth Service dependencies installed"
        fi
        
        # Shared utilities
        if [ -f "microservices/shared/package.json" ]; then
            print_info "üì¶ Installing Shared utilities dependencies..."
            cd microservices/shared
            if ! npm install --production; then
                print_error "Failed to install Shared utilities dependencies"
                cd ../..
                return 1
            fi
            cd ../..
            print_success "Shared utilities dependencies installed"
        fi
    fi
    
    print_success "All npm dependencies installed successfully"
    return 0
}

# Check if Docker is installed and running
check_docker() {
    print_step "Checking Docker installation..."
    
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed. Please install Docker first:"
        echo ""
        echo "üêß Linux: curl -fsSL https://get.docker.com | sh"
        echo "üçé macOS: Download Docker Desktop from https://docker.com"
        echo ""
        return 1
    fi
    
    if ! docker info &> /dev/null; then
        print_error "Docker daemon is not running. Please start Docker:"
        echo ""
        echo "üêß Linux: sudo systemctl start docker"
        echo "üçé macOS: Start Docker Desktop"
        echo ""
        return 1
    fi
    
    print_success "Docker is installed and running"
    
    # Check Docker Compose
    if docker compose version &> /dev/null; then
        COMPOSE_CMD="docker compose"
    elif command -v docker-compose &> /dev/null; then
        COMPOSE_CMD="docker-compose"
    else
        print_error "Docker Compose is not available"
        return 1
    fi
    
    print_success "Docker Compose is available"
    return 0
}

# Main installation function
install_aaiti() {
    print_step "Starting A.A.I.T.I installation..."
    
    if ! check_docker; then
        print_error "Docker setup failed. Please install Docker and try again."
        echo ""
        echo "Visit: https://docs.docker.com/get-docker/"
        exit 1
    fi
    
    echo ""
    print_info "üê≥ A.A.I.T.I will be installed using Docker"
    print_info "üìä This creates a production-ready trading platform"
    echo ""
    
    # Ask for confirmation
    echo ""
    echo -ne "${CYAN}Continue with installation? (y/N): ${NC}"
    read -r confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        print_info "Installation cancelled"
        exit 0
    fi
    
    # Automatically install npm dependencies (non-blocking)
    echo ""
    print_step "Preparing development dependencies (optional)..."
    if check_nodejs; then
        if ! install_npm_dependencies; then
            print_warning "npm dependency installation failed. Continuing with Docker installation..."
        fi
    else
        print_info "Skipping npm dependency installation (Node.js not available)."
    fi

    # Run simplified setup (no interactive prompts)
    echo ""
    print_step "Preparing installation..."
    setup_configuration
    
    # Build image(s)
    print_step "Building Docker containers (this may take a few minutes)..."
    echo -ne "${YELLOW}Building: "
    for _ in {1..20}; do
        echo -ne "‚ñì"
        sleep 0.1
    done
    echo -e " ${GREEN}‚úì${NC}"
    
    if ! $COMPOSE_CMD build aaiti; then
        print_error "Failed to build Docker containers"
        print_error "Please check Docker is running and try again"
        exit 1
    fi

    # Skip admin initialization - will be done through dashboard
    print_info "Admin setup will be done through dashboard welcome flow"

    # Offer to start now
    echo ""
    echo -ne "${CYAN}Start A.A.I.T.I services now? (Y/n): ${NC}"
    read -r start_confirm
    if [[ -z "$start_confirm" || $start_confirm =~ ^[Yy]$ ]]; then
        print_step "Starting A.A.I.T.I services..."
        echo -ne "${YELLOW}Starting: "
        for _ in {1..15}; do
            echo -ne "‚ñì"
            sleep 0.1
        done
        echo -e " ${GREEN}‚úì${NC}"

        if ! $COMPOSE_CMD up -d aaiti; then
            print_error "Failed to start services"
            print_error "Please check the logs with: $COMPOSE_CMD logs aaiti"
            exit 1
        fi

        # Wait for services
        print_step "Waiting for services to initialize..."
        echo -ne "${CYAN}Initializing"
        for _ in {1..30}; do
            echo -ne "."
            sleep 0.3
        done
        echo -e " ${GREEN}Ready!${NC}"
    else
        print_info "You can start later with: ./install start"
    fi
    
    # Success message
    echo ""
    echo -e "${GREEN}${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}${WHITE}‚ïë                           üéâ Installation Complete! üéâ                                  ‚ïë${NC}"
    echo -e "${GREEN}${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${WHITE}üìä A.A.I.T.I Dashboard:${NC} ${BLUE}http://localhost:5000${NC}"
    echo ""
    echo -e "${WHITE}Management Commands:${NC}"
    echo -e "${CYAN}‚ñ∂Ô∏è  Start:${NC} ./install start"
    echo -e "${CYAN}üìä Check status:${NC} ./install status"
    echo -e "${CYAN}üìã View logs:${NC} ./install logs"
    echo -e "${CYAN}‚èπÔ∏è  Stop:${NC} ./install stop"
    echo -e "${CYAN}üîÑ Restart:${NC} ./install restart"
    echo ""
    
    echo -e "${WHITE}Development Commands:${NC}"
    echo -e "${CYAN}üõ†Ô∏è  Frontend dev:${NC} cd frontend && npm start"
    echo -e "${CYAN}üõ†Ô∏è  Backend dev:${NC} cd backend && npm run dev"
    echo -e "${CYAN}üõ†Ô∏è  API Gateway:${NC} cd microservices/api-gateway && npm run dev"
    echo -e "${CYAN}üõ†Ô∏è  Auth Service:${NC} cd microservices/auth-service && npm run dev"
    echo ""
}

# Install only npm dependencies
install_dependencies_only() {
    print_step "Installing npm dependencies only..."
    
    if ! check_nodejs; then
        print_error "Node.js setup failed. Please install Node.js manually."
        echo ""
        echo "Visit: https://nodejs.org/"
        exit 1
    fi
    
    if ! install_npm_dependencies; then
        print_error "Failed to install npm dependencies"
        exit 1
    fi
    
    print_success "All npm dependencies installed successfully!"
    echo ""
    echo -e "${WHITE}Next steps:${NC}"
    echo -e "${CYAN}üõ†Ô∏è  Frontend dev:${NC} cd frontend && npm start"
    echo -e "${CYAN}üõ†Ô∏è  Backend dev:${NC} cd backend && npm run dev"
    echo -e "${CYAN}üõ†Ô∏è  API Gateway:${NC} cd microservices/api-gateway && npm run dev"
    echo -e "${CYAN}üõ†Ô∏è  Auth Service:${NC} cd microservices/auth-service && npm run dev"
    echo -e "${CYAN}üê≥ Full Docker setup:${NC} ./install"
    echo ""
}

# Start A.A.I.T.I
start_aaiti() {
    print_step "Starting A.A.I.T.I services..."

    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi

    # Build if needed and start
    if ! $COMPOSE_CMD up -d --build aaiti; then
        print_error "Failed to start services"
        print_error "Please check the logs with: $COMPOSE_CMD logs aaiti"
        return 1
    fi

    # Wait briefly and show status
    sleep 2
    check_status
}

# Restart A.A.I.T.I
restart_aaiti() {
    print_step "Restarting A.A.I.T.I..."

    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi

    if $COMPOSE_CMD restart aaiti; then
        print_success "A.A.I.T.I restarted"
        sleep 2
        check_status
    else
        print_error "Failed to restart A.A.I.T.I"
    fi
}

# Check status of existing installation (robust)
check_status() {
    print_step "Checking A.A.I.T.I status..."

    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi

    # Get container ID (may be empty)
    CONTAINER_ID=$($COMPOSE_CMD ps -q aaiti 2>/dev/null || true)

    if [ -z "$CONTAINER_ID" ]; then
        print_warning "A.A.I.T.I container not created or not running"
        echo "Use: ./install start"
        return 0
    fi

    # Read runtime status and health
    STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")
    HEALTH=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")

    case "$STATUS" in
        running)
            print_success "A.A.I.T.I is running (health: $HEALTH)"
            ;;
        exited|dead)
            print_error "A.A.I.T.I is stopped (status: $STATUS)"
            echo "Use: ./install start"
            ;;
        created|restarting|paused)
            print_warning "A.A.I.T.I status: $STATUS (health: $HEALTH)"
            ;;
        *)
            print_warning "A.A.I.T.I status: $STATUS"
            ;;
    esac

    # Show dashboard URL when running
    if [ "$STATUS" = "running" ]; then
        echo -e "${BLUE}üìä Dashboard: http://localhost:5000${NC}"
        # Quick HTTP health probe (non-fatal)
        if command -v curl &> /dev/null; then
            if curl -fsS http://localhost:5000/api/health >/dev/null 2>&1; then
                print_success "HTTP health endpoint is responding"
            else
                print_warning "HTTP health endpoint not responding yet"
            fi
        fi
    else
        # Show last logs to help diagnose
        print_info "Recent logs (last 50 lines):"
        $COMPOSE_CMD logs --tail 50 aaiti || true
    fi
}

# Stop A.A.I.T.I
stop_aaiti() {
    print_step "Stopping A.A.I.T.I..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    if $COMPOSE_CMD down; then
        print_success "A.A.I.T.I stopped successfully"
    else
        print_error "Failed to stop A.A.I.T.I"
    fi
}

# Show logs
show_logs() {
    print_step "Showing A.A.I.T.I logs..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    print_info "Press Ctrl+C to exit logs"
    sleep 2
    $COMPOSE_CMD logs -f aaiti
}

# Show help
show_help() {
    echo "${PROJECT_NAME} Interactive Docker Installer"
    echo ""
    echo "This installer creates a production-ready ${PROJECT_NAME} trading platform using Docker."
    echo ""
    echo "Requirements:"
    echo "  ‚Ä¢ Docker 20.0+ with Docker Compose"
    echo "  ‚Ä¢ 4GB RAM (recommended)"
    echo "  ‚Ä¢ 2GB disk space"
    echo "  ‚Ä¢ Internet connection"
    echo "  ‚Ä¢ Node.js 18+ and npm (for development mode)"
    echo ""
    echo "Supported Platforms:"
    echo "  ‚Ä¢ Linux (all distributions with Docker support)"
    echo "  ‚Ä¢ macOS with Docker Desktop"
    echo ""
    echo "Installation Types:"
    echo "  ‚Ä¢ Docker-only: Production-ready containerized deployment"
    echo "  ‚Ä¢ Full: Docker + npm dependencies for development"
    echo ""
    echo "Usage:"
    echo "  ./install             # Interactive menu"
    echo "  ./install help        # Show this help"
    echo "  ./install start       # Build (if needed) and start services"
    echo "  ./install restart     # Restart services"
    echo "  ./install stop        # Stop services"
    echo "  ./install status      # Show status"
    echo "  ./install logs        # Tail logs"
    echo ""
}

# Reinstall (rebuild) keeping or wiping volumes
reinstall_aaiti() {
    print_step "Reinstalling ${PROJECT_NAME}..."

    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi

    echo -e "${YELLOW}This will rebuild the image. You may optionally wipe data volumes.${NC}"
    echo -ne "Preserve existing data volumes? (Y/n): "
    read -r preserve
    local remove_vols=false
    if [[ $preserve =~ ^[Nn]$ ]]; then
        remove_vols=true
    fi

    print_info "Stopping services (if running)..."
    $COMPOSE_CMD down || true

    if [ "$remove_vols" = true ]; then
        print_warning "Removing volumes (data loss)..."
        $COMPOSE_CMD down -v || true
        print_success "Volumes removed"
        echo -ne "Rotate JWT secret (recommended when wiping)? (Y/n): "
        read -r rot
        if [[ -z $rot || $rot =~ ^[Yy]$ ]]; then
            export AAITI_FORCE_ROTATE_JWT=1
        fi
    fi

    echo -ne "Re-run admin configuration? (Y/n): "
    read -r rerun_conf
    if [[ -z $rerun_conf || $rerun_conf =~ ^[Yy]$ ]]; then
        setup_configuration true
    else
        print_info "Keeping existing configuration (.aaiti_setup.env)"
    fi

    print_step "Rebuilding image (no cache)..."
    if ! $COMPOSE_CMD build --no-cache aaiti; then
        print_error "Image rebuild failed"
        return 1
    fi
    print_success "Image rebuilt"

    if [ "$remove_vols" = true ] && [ -f .aaiti_setup.env ]; then
        # shellcheck disable=SC1091
        source .aaiti_setup.env
        print_step "Initializing admin in fresh volumes..."
        INIT_CMD="$COMPOSE_CMD run --rm -e PORT=$AAITI_APP_PORT aaiti node backend/scripts/init-admin.js --username $AAITI_ADMIN_USERNAME --email $AAITI_ADMIN_EMAIL --password $AAITI_ADMIN_PASSWORD --port $AAITI_APP_PORT"
        if [ "${AAITI_FORCE_ROTATE_JWT:-0}" = "1" ]; then
            INIT_CMD+=" --rotate-jwt"
        elif [ "$AAITI_ROTATE_JWT" = "1" ]; then
            INIT_CMD+=" --rotate-jwt"
        fi
        if eval "$INIT_CMD" >/dev/null 2>&1; then
            print_success "Admin reinitialized"
        else
            print_warning "Admin init inside container failed; run manually later."
        fi
    fi

    echo -ne "Start services now? (Y/n): "
    read -r start_now
    if [[ -z $start_now || $start_now =~ ^[Yy]$ ]]; then
        start_aaiti
    else
        print_info "You can start later with: ./install start"
    fi
}

# Complete removal (uninstall)
remove_aaiti() {
    print_step "Removing ${PROJECT_NAME}..."
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    echo -e "${RED}This will stop and delete the container and image. Optionally delete volumes (DATA LOSS).${NC}"
    echo -ne "Type DELETE to continue: "
    read -r confirm
    if [[ "$confirm" != "DELETE" ]]; then
        print_info "Removal cancelled"
        return 0
    fi
    echo -ne "Also remove volumes? (type WIPE to confirm): "
    read -r wipe
    if [[ "$wipe" == "WIPE" ]]; then
        print_warning "Removing with volumes..."
        $COMPOSE_CMD down -v || true
    else
        $COMPOSE_CMD down || true
    fi
    # Attempt to remove image(s) built for service
    IMG_IDS=$(docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep -i aaiti | awk '{print $2}' | sort -u || true)
    for iid in $IMG_IDS; do
        print_info "Removing image $iid"
        docker rmi -f "$iid" >/dev/null 2>&1 || true
    done
    docker image prune -f >/dev/null 2>&1 || true
    print_success "${PROJECT_NAME} removed. Local config files remain (delete manually if desired)."
}

# Fancy header showing status & config
stylish_header() {
    local status="Not Installed"
    if command -v docker >/dev/null 2>&1; then
        if docker ps --format '{{.Names}}' | grep -q '^aaiti$'; then
            status="Running"
        elif docker ps -a --format '{{.Names}}' | grep -q '^aaiti$'; then
            status="Stopped"
        fi
    fi
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    printf "${BLUE}‚ïë${NC}  üöÄ %-54s ${BLUE}‚ïë\n" "${PROJECT_NAME} v${VERSION}"
    printf "${BLUE}‚ïë${NC}  üìä Status: %-44s ${BLUE}‚ïë\n" "$status"
    if [ -f .aaiti_setup.env ]; then
        # shellcheck disable=SC1091
        source .aaiti_setup.env
        printf "${BLUE}‚ïë${NC}  üë§ Admin: %-45s ${BLUE}‚ïë\n" "${AAITI_ADMIN_USERNAME:-admin}"
        printf "${BLUE}‚ïë${NC}  üåê Port: %-46s ${BLUE}‚ïë\n" "${AAITI_APP_PORT:-5000}"
    else
        printf "${BLUE}‚ïë${NC}  ‚öôÔ∏è  Run setup to configure admin & port          ${BLUE}‚ïë\n"
    fi
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# Main menu
main_menu() {
    while true; do
        echo ""
        stylish_header
        echo ""
        echo -e "${CYAN}Main Menu${NC}"
        echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
        echo "1) Install (Production)"
        echo "2) Start"
        echo "3) Status"
        echo "4) Stop"
        echo "5) Logs"
        echo "6) Help"
    echo "7) Reset Accounts & Credentials (Destructive)"
    echo "8) Rebuild Image"
        echo "9) Remove (Uninstall)"
        echo "0) Exit"
        echo ""
        echo -ne "${CYAN}Select an option (0-9): ${NC}"
        read -r choice
        
        case $choice in
            1)
                install_aaiti
                ;;
            2)
                start_aaiti
                ;;
            3)
                check_status
                ;;
            4)
                stop_aaiti
                ;;
            5)
                show_logs
                ;;
            6)
                show_help
                ;;
            7)
                echo -e "${RED}This will DELETE all user accounts, audit logs & credentials. Next registered user becomes ADMIN.${NC}"
                echo -ne "Type RESET to proceed: "
                read -r confirm_reset
                if [[ "$confirm_reset" == "RESET" ]]; then
                    if ! check_docker; then
                        print_error "Docker not available"
                    else
                        print_step "Wiping user accounts & audit logs (script)..."
                        if $COMPOSE_CMD run --rm aaiti node backend/scripts/reset-accounts.js 2>/dev/null; then
                            print_success "Accounts & credentials wiped. Register a new user to bootstrap admin."
                        else
                            print_warning "Automatic wipe failed. Manual command inside container shell:"
                            echo "node backend/scripts/reset-accounts.js"
                        fi
                    fi
                else
                    print_info "Reset cancelled"
                fi
                ;;
            8)
                echo -e "${PURPLE}Rebuilding image (no data volume wipe)...${NC}"
                if ! check_docker; then
                    print_error "Docker not available"
                else
                    if $COMPOSE_CMD build --no-cache aaiti; then
                        print_success "Image rebuilt"
                        echo -ne "Restart running service now? (Y/n): "
                        read -r rs
                        if [[ -z $rs || $rs =~ ^[Yy]$ ]]; then
                            $COMPOSE_CMD up -d aaiti && print_success "Service running with rebuilt image" || print_error "Failed to start service"
                        else
                            print_info "You can start later with: ./install start"
                        fi
                    else
                        print_error "Rebuild failed"
                    fi
                fi
                ;;
            9)
                remove_aaiti
                ;;
            0)
                print_info "Goodbye! üëã"
                exit 0
                ;;
            *)
                print_error "Invalid selection. Please choose 0-9."
                sleep 2
                ;;
        esac
        
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
    done
}

# Handle command line arguments
case "${1:-}" in
    "help"|"--help"|"-h")
        show_help
        ;;
    "status"|"check")
        check_status
        ;;
    "start")
        start_aaiti
        ;;
    "restart")
        restart_aaiti
        ;;
    "stop")
        stop_aaiti
        ;;
    "logs")
        show_logs
        ;;
    *)
        main_menu
        ;;
esac