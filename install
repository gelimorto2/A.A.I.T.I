#!/bin/bash

# A.A.I.T.I Interactive Docker Installer v2.0
# Streamlined Docker-based installation with configuration management

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Configuration
PROJECT_NAME="A.A.I.T.I"
VERSION="2.1.0"
COMPOSE_CMD=""

# Print header
print_header() {
    echo -e "${BLUE}"
    cat << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ${PROJECT_NAME} v${VERSION} - Interactive Installer                â•‘
â•‘                      Auto AI Trading Interface - Docker Edition                      â•‘
â•‘                    Automated Artificial Intelligence Trading Interface               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
}

# Print functions
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_step() {
    echo -e "${PURPLE}ğŸ”§ $1${NC}"
}

# Check if Docker is installed and running
check_docker() {
    print_step "Checking Docker installation..."
    
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed. Please install Docker first:"
        echo ""
        echo "ğŸ§ Linux: curl -fsSL https://get.docker.com | sh"
        echo "ğŸ macOS: Download Docker Desktop from https://docker.com"
        echo "ğŸªŸ Windows: Download Docker Desktop from https://docker.com"
        echo ""
        return 1
    fi
    
    if ! docker info &> /dev/null; then
        print_error "Docker daemon is not running. Please start Docker:"
        echo ""
        echo "ğŸ§ Linux: sudo systemctl start docker"
        echo "ğŸ macOS: Start Docker Desktop"
        echo "ğŸªŸ Windows: Start Docker Desktop"
        echo ""
        return 1
    fi
    
    print_success "Docker is installed and running"
    
    # Check Docker Compose
    if docker compose version &> /dev/null; then
        COMPOSE_CMD="docker compose"
    elif command -v docker-compose &> /dev/null; then
        COMPOSE_CMD="docker-compose"
    else
        print_error "Docker Compose is not available"
        return 1
    fi
    
    print_success "Docker Compose is available"
    return 0
}

# Run configuration generator
run_config_generator() {
    print_step "Running configuration wizard..."
    
    if [ ! -f "scripts/config-generator.sh" ]; then
        print_error "Configuration generator not found at scripts/config-generator.sh"
        return 1
    fi
    
    # Make it executable
    chmod +x scripts/config-generator.sh
    
    # Run the configuration generator
    if ! bash scripts/config-generator.sh; then
        print_error "Configuration generator failed"
        return 1
    fi
    
    print_success "Configuration completed"
    return 0
}

# Main installation function
install_aaiti() {
    print_header
    print_step "Starting A.A.I.T.I installation..."
    
    if ! check_docker; then
        print_error "Docker setup failed. Please install Docker and try again."
        echo ""
        echo "Visit: https://docs.docker.com/get-docker/"
        exit 1
    fi
    
    echo ""
    print_info "ğŸ³ A.A.I.T.I will be installed using Docker"
    print_info "ğŸ“Š This creates a production-ready trading platform"
    echo ""
    
    # Check if .env exists
    if [ ! -f ".env" ]; then
        print_warning ".env configuration file not found"
        echo ""
        echo -ne "${CYAN}Run configuration wizard now? (Y/n): ${NC}"
        read -r config_confirm
        
        if [[ -z "$config_confirm" || $config_confirm =~ ^[Yy]$ ]]; then
            if ! run_config_generator; then
                print_error "Configuration failed. Installation cannot continue."
                exit 1
            fi
        else
            print_error "Installation requires .env configuration file"
            print_info "Run: ${YELLOW}bash scripts/config-generator.sh${NC}"
            exit 1
        fi
    else
        print_success "Using existing .env configuration"
        echo ""
        echo -ne "${CYAN}Reconfigure settings? (y/N): ${NC}"
        read -r reconfig_confirm
        
        if [[ $reconfig_confirm =~ ^[Yy]$ ]]; then
            if ! run_config_generator; then
                print_warning "Configuration update failed, using existing .env"
            fi
        fi
    fi
    
    # Ask for confirmation
    echo ""
    echo -ne "${CYAN}Continue with installation? (Y/n): ${NC}"
    read -r confirm
    
    if [[ ! -z "$confirm" && ! $confirm =~ ^[Yy]$ ]]; then
        print_info "Installation cancelled"
        exit 0
    fi
    
    # Build Docker containers
    print_step "Building Docker containers (this may take a few minutes)..."
    echo -ne "${YELLOW}Building: "
    for _ in {1..20}; do
        echo -ne "â–“"
        sleep 0.1
    done
    echo -e " ${GREEN}âœ“${NC}"
    
    if ! $COMPOSE_CMD build aaiti; then
        print_error "Failed to build Docker containers"
        print_error "Please check Docker is running and try again"
        exit 1
    fi
    
    print_success "Docker containers built successfully"
    
    # Offer to start now
    echo ""
    echo -ne "${CYAN}Start A.A.I.T.I services now? (Y/n): ${NC}"
    read -r start_confirm
    
    if [[ -z "$start_confirm" || $start_confirm =~ ^[Yy]$ ]]; then
        print_step "Starting A.A.I.T.I services..."
        echo -ne "${YELLOW}Starting: "
        for _ in {1..15}; do
            echo -ne "â–“"
            sleep 0.1
        done
        echo -e " ${GREEN}âœ“${NC}"
        
        if ! $COMPOSE_CMD up -d aaiti; then
            print_error "Failed to start services"
            print_error "Check logs with: $COMPOSE_CMD logs aaiti"
            exit 1
        fi
        
        # Wait for services
        print_step "Waiting for services to initialize..."
        echo -ne "${CYAN}Initializing"
        for _ in {1..30}; do
            echo -ne "."
            sleep 0.3
        done
        echo -e " ${GREEN}Ready!${NC}"
        
        # Show status
        check_status
    else
        print_info "You can start later with: ./install start"
    fi
    
    # Success message
    echo ""
    echo -e "${GREEN}${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}${WHITE}â•‘                           ğŸ‰ Installation Complete! ğŸ‰                                â•‘${NC}"
    echo -e "${GREEN}${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Get port from .env if available
    PORT="5000"
    if [ -f ".env" ]; then
        PORT_FROM_ENV=$(grep "^PORT=" .env | cut -d '=' -f2 || echo "5000")
        if [ -n "$PORT_FROM_ENV" ]; then
            PORT="$PORT_FROM_ENV"
        fi
    fi
    
    echo -e "${WHITE}ğŸ“Š A.A.I.T.I Dashboard:${NC} ${BLUE}http://localhost:$PORT${NC}"
    echo ""
    echo -e "${WHITE}Management Commands:${NC}"
    echo -e "${CYAN}â–¶ï¸  Start:${NC} ./install start"
    echo -e "${CYAN}ğŸ“Š Status:${NC} ./install status"
    echo -e "${CYAN}ğŸ“‹ Logs:${NC} ./install logs"
    echo -e "${CYAN}â¹ï¸  Stop:${NC} ./install stop"
    echo -e "${CYAN}ğŸ”„ Restart:${NC} ./install restart"
    echo -e "${CYAN}âš™ï¸  Reconfigure:${NC} bash scripts/config-generator.sh"
    echo ""
}

# Start A.A.I.T.I
start_aaiti() {
    print_step "Starting A.A.I.T.I services..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    # Check for .env
    if [ ! -f ".env" ]; then
        print_error ".env configuration file not found"
        print_info "Run: ./install to configure and install"
        return 1
    fi
    
    # Build if needed and start
    if ! $COMPOSE_CMD up -d aaiti; then
        print_error "Failed to start services"
        print_error "Check logs with: $COMPOSE_CMD logs aaiti"
        return 1
    fi
    
    # Wait briefly and show status
    sleep 3
    check_status
}

# Restart A.A.I.T.I
restart_aaiti() {
    print_step "Restarting A.A.I.T.I..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    if $COMPOSE_CMD restart aaiti; then
        print_success "A.A.I.T.I restarted"
        sleep 2
        check_status
    else
        print_error "Failed to restart A.A.I.T.I"
    fi
}

# Check status
check_status() {
    print_step "Checking A.A.I.T.I status..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    # Get container ID
    CONTAINER_ID=$($COMPOSE_CMD ps -q aaiti 2>/dev/null || true)
    
    if [ -z "$CONTAINER_ID" ]; then
        print_warning "A.A.I.T.I container not running"
        echo "Use: ./install start"
        return 0
    fi
    
    # Get status and health
    STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")
    HEALTH=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")
    
    case "$STATUS" in
        running)
            print_success "A.A.I.T.I is running (health: $HEALTH)"
            
            # Get port from .env
            PORT="5000"
            if [ -f ".env" ]; then
                PORT=$(grep "^PORT=" .env | cut -d '=' -f2 || echo "5000")
            fi
            
            echo -e "${BLUE}ğŸ“Š Dashboard: http://localhost:$PORT${NC}"
            
            # HTTP health check
            if command -v curl &> /dev/null; then
                if curl -fsS "http://localhost:$PORT/api/health" >/dev/null 2>&1; then
                    print_success "API is responding"
                else
                    print_warning "API not responding yet (may still be starting)"
                fi
            fi
            ;;
        exited|dead)
            print_error "A.A.I.T.I is stopped (status: $STATUS)"
            echo ""
            print_info "Recent logs:"
            $COMPOSE_CMD logs --tail 30 aaiti || true
            echo ""
            echo "Use: ./install start"
            ;;
        *)
            print_warning "A.A.I.T.I status: $STATUS (health: $HEALTH)"
            ;;
    esac
}

# Stop A.A.I.T.I
stop_aaiti() {
    print_step "Stopping A.A.I.T.I..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    if $COMPOSE_CMD down; then
        print_success "A.A.I.T.I stopped successfully"
    else
        print_error "Failed to stop A.A.I.T.I"
    fi
}

# Show logs
show_logs() {
    print_step "Showing A.A.I.T.I logs..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    print_info "Press Ctrl+C to exit logs"
    sleep 2
    $COMPOSE_CMD logs -f aaiti
}

# Show help
show_help() {
    echo -e "${WHITE}${PROJECT_NAME} Interactive Docker Installer v${VERSION}${NC}"
    echo ""
    echo "This installer creates a production-ready ${PROJECT_NAME} trading platform using Docker."
    echo ""
    echo -e "${CYAN}Requirements:${NC}"
    echo "  â€¢ Docker 20.0+ with Docker Compose"
    echo "  â€¢ 4GB RAM (recommended)"
    echo "  â€¢ 2GB disk space"
    echo "  â€¢ Internet connection"
    echo ""
    echo -e "${CYAN}Supported Platforms:${NC}"
    echo "  â€¢ Linux (all distributions with Docker support)"
    echo "  â€¢ macOS with Docker Desktop"
    echo "  â€¢ Windows with Docker Desktop (WSL2)"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  ./install              # Interactive menu"
    echo "  ./install help         # Show this help"
    echo "  ./install start        # Start services"
    echo "  ./install restart      # Restart services"
    echo "  ./install stop         # Stop services"
    echo "  ./install status       # Show status"
    echo "  ./install logs         # Tail logs"
    echo ""
    echo -e "${CYAN}Configuration:${NC}"
    echo "  bash scripts/config-generator.sh    # Run configuration wizard"
    echo ""
}

# Reconfigure
reconfigure() {
    print_step "Running configuration wizard..."
    
    if ! run_config_generator; then
        print_error "Configuration failed"
        return 1
    fi
    
    echo ""
    echo -ne "${CYAN}Rebuild containers with new configuration? (Y/n): ${NC}"
    read -r rebuild_confirm
    
    if [[ -z "$rebuild_confirm" || $rebuild_confirm =~ ^[Yy]$ ]]; then
        print_step "Rebuilding containers..."
        
        # Stop if running
        $COMPOSE_CMD down 2>/dev/null || true
        
        # Rebuild
        if $COMPOSE_CMD build --no-cache aaiti; then
            print_success "Containers rebuilt"
            
            echo -ne "${CYAN}Start services now? (Y/n): ${NC}"
            read -r start_confirm
            
            if [[ -z "$start_confirm" || $start_confirm =~ ^[Yy]$ ]]; then
                start_aaiti
            fi
        else
            print_error "Rebuild failed"
        fi
    fi
}

# Complete removal
remove_aaiti() {
    print_step "Removing ${PROJECT_NAME}..."
    
    if ! check_docker; then
        print_error "Docker is not available"
        return 1
    fi
    
    echo -e "${RED}âš ï¸  WARNING: This will stop and delete containers and images.${NC}"
    echo -e "${RED}âš ï¸  Data volumes can optionally be preserved.${NC}"
    echo ""
    echo -ne "${YELLOW}Type DELETE to confirm removal: ${NC}"
    read -r confirm
    
    if [[ "$confirm" != "DELETE" ]]; then
        print_info "Removal cancelled"
        return 0
    fi
    
    echo ""
    echo -ne "${YELLOW}Also remove data volumes? (y/N): ${NC}"
    read -r wipe
    
    if [[ $wipe =~ ^[Yy]$ ]]; then
        print_warning "Removing with volumes (DATA WILL BE LOST)..."
        $COMPOSE_CMD down -v || true
    else
        $COMPOSE_CMD down || true
    fi
    
    # Remove images
    print_info "Removing Docker images..."
    IMG_IDS=$(docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep -i aaiti | awk '{print $2}' | sort -u || true)
    for iid in $IMG_IDS; do
        docker rmi -f "$iid" >/dev/null 2>&1 || true
    done
    docker image prune -f >/dev/null 2>&1 || true
    
    print_success "${PROJECT_NAME} removed"
    print_info "Configuration files (.env) remain - delete manually if desired"
}

# Stylish header with status
stylish_header() {
    local status="Not Installed"
    local port="5000"
    
    if command -v docker >/dev/null 2>&1; then
        if docker ps --format '{{.Names}}' | grep -q '^aaiti'; then
            status="Running"
        elif docker ps -a --format '{{.Names}}' | grep -q '^aaiti'; then
            status="Stopped"
        fi
    fi
    
    if [ -f ".env" ]; then
        port=$(grep "^PORT=" .env | cut -d '=' -f2 2>/dev/null || echo "5000")
    fi
    
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    printf "${BLUE}â•‘${NC}  ğŸš€ %-54s${BLUE}â•‘${NC}\n" "${PROJECT_NAME} v${VERSION}"
    printf "${BLUE}â•‘${NC}  ğŸ“Š Status: %-45s${BLUE}â•‘${NC}\n" "$status"
    printf "${BLUE}â•‘${NC}  ğŸŒ Port: %-47s${BLUE}â•‘${NC}\n" "$port"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# Main menu
main_menu() {
    while true; do
        echo ""
        stylish_header
        echo ""
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${CYAN}  Main Menu${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "  1) ğŸš€ Install / Full Setup"
        echo "  2) â–¶ï¸  Start Services"
        echo "  3) ğŸ“Š Check Status"
        echo "  4) â¹ï¸  Stop Services"
        echo "  5) ğŸ“‹ View Logs"
        echo "  6) ğŸ”„ Restart Services"
        echo "  7) âš™ï¸  Reconfigure"
        echo "  8) â“ Help"
        echo "  9) ğŸ—‘ï¸  Remove / Uninstall"
        echo "  0) ğŸšª Exit"
        echo ""
        echo -ne "${CYAN}Select an option (0-9): ${NC}"
        read -r choice
        
        case $choice in
            1)
                install_aaiti
                ;;
            2)
                start_aaiti
                ;;
            3)
                check_status
                ;;
            4)
                stop_aaiti
                ;;
            5)
                show_logs
                ;;
            6)
                restart_aaiti
                ;;
            7)
                reconfigure
                ;;
            8)
                show_help
                ;;
            9)
                remove_aaiti
                ;;
            0)
                print_info "Goodbye! ğŸ‘‹"
                exit 0
                ;;
            *)
                print_error "Invalid selection. Please choose 0-9."
                sleep 2
                ;;
        esac
        
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read -r
    done
}

# Handle command line arguments
case "${1:-}" in
    "help"|"--help"|"-h")
        show_help
        ;;
    "status"|"check")
        check_status
        ;;
    "start")
        start_aaiti
        ;;
    "restart")
        restart_aaiti
        ;;
    "stop")
        stop_aaiti
        ;;
    "logs")
        show_logs
        ;;
    "config"|"configure")
        reconfigure
        ;;
    "remove"|"uninstall")
        remove_aaiti
        ;;
    *)
        main_menu
        ;;
esac
