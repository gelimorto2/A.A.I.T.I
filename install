#!/bin/bash

# A.A.I.T.I Universal Installer
# Cross-platform installer that auto-detects your system

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print header
echo -e "${BLUE}"
cat << "EOF"
╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                              🚀 A.A.I.T.I v2.0.0 - Universal Installer                                             ║
║                               Auto AI Trading Interface - Cross-Platform Setup                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Function to print messages
print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

# Detect operating system
detect_os() {
    case "$(uname -s)" in
        Linux*)
            OS="linux"
            print_info "Detected: Linux"
            ;;
        Darwin*)
            OS="macos"
            print_info "Detected: macOS"
            ;;
        CYGWIN*|MINGW*|MSYS*)
            OS="windows"
            print_info "Detected: Windows (WSL/Git Bash)"
            ;;
        *)
            OS="linux"
            print_warning "Unknown OS, defaulting to Linux"
            ;;
    esac
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Main installation function
main() {
    detect_os
    
    echo ""
    print_info "Starting A.A.I.T.I installation for $OS..."
    echo ""
    
    # Check for OS-specific implementation
    IMPL_SCRIPT="$SCRIPT_DIR/scripts/$OS/install-impl.sh"
    
    if [ -f "$IMPL_SCRIPT" ]; then
        print_info "Using OS-specific installer: $IMPL_SCRIPT"
        exec "$IMPL_SCRIPT" "$@"
    else
        # Fallback to original installer
        print_warning "OS-specific installer not found, using universal installer"
        if [ -f "$SCRIPT_DIR/install.sh" ]; then
            exec "$SCRIPT_DIR/install.sh" "$@"
        else
            print_error "No installer found. Please check your installation."
            exit 1
        fi
    fi
}

# Show help if requested
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "A.A.I.T.I Universal Installer"
    echo ""
    echo "Usage: ./install [options]"
    echo ""
    echo "Options:"
    echo "  --help, -h     Show this help message"
    echo "  --docker       Use Docker installation"
    echo "  --dev          Development installation"
    echo "  --production   Production installation"
    echo ""
    echo "The installer will auto-detect your operating system and"
    echo "use the appropriate installation method."
    echo ""
    exit 0
fi

# Check for Docker flag
if [[ "$1" == "--docker" ]]; then
    print_info "Using Docker installation method"
    if [ -f "$SCRIPT_DIR/install-docker.sh" ]; then
        exec "$SCRIPT_DIR/install-docker.sh"
    else
        print_error "Docker installer not found"
        exit 1
    fi
fi

# Run main installation
main "$@"